<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>BELOURA NY ‚Ä¢ Panel interno</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:#020617;
      color:#e5e7eb;
    }
    .wrap{
      max-width:1040px;
      margin:0 auto;
      padding:24px 16px 48px;
    }
    h1{
      margin:0 0 4px;
      font-size:1.6rem;
    }
    .muted{color:#9ca3af;font-size:0.85rem;}
    .badge{
      display:inline-block;
      font-size:0.75rem;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #4b5563;
      color:#9ca3af;
    }
    .tabs{
      margin-top:20px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tab-btn{
      border:none;
      border-radius:999px;
      padding:7px 14px;
      font-size:0.85rem;
      cursor:pointer;
      background:#111827;
      color:#9ca3af;
    }
    .tab-btn.active{
      background:#22c55e;
      color:#052e16;
      font-weight:600;
    }
    .card{
      margin-top:16px;
      background:#020617;
      border:1px solid #1f2937;
      border-radius:18px;
      padding:18px;
    }
    .section-title{
      font-size:0.9rem;
      font-weight:600;
      margin:12px 0 4px;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:#9ca3af;
    }
    .grid{
      display:grid;
      gap:12px;
    }
    @media(min-width:800px){
      .grid-2{grid-template-columns:1fr 1fr;}
      .grid-3{grid-template-columns:repeat(3,1fr);}
    }
    label{
      display:block;
      font-size:0.8rem;
      margin-bottom:4px;
    }
    input,select,textarea{
      width:100%;
      box-sizing:border-box;
      padding:9px 11px;
      border-radius:10px;
      border:1px solid #1f2937;
      background:#020617;
      color:#e5e7eb;
      font-size:0.88rem;
    }
    input:focus,select:focus,textarea:focus{
      outline:none;
      border-color:#22c55e;
      box-shadow:0 0 0 1px #22c55e55;
    }
    textarea{min-height:60px;resize:vertical;}
    .flex{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    button{
      border:none;
      border-radius:999px;
      padding:9px 16px;
      font-size:0.9rem;
      cursor:pointer;
      font-weight:600;
    }
    .btn-primary{
      background:#22c55e;
      color:#052e16;
    }
    .btn-secondary{
      background:transparent;
      color:#e5e7eb;
      border:1px solid #4b5563;
    }
    .btn-primary:disabled{
      opacity:.6;
      cursor:default;
    }
    .alert{
      margin-top:12px;
      border-radius:12px;
      padding:9px 11px;
      font-size:0.82rem;
    }
    .alert-ok{
      background:#022c22;
      border:1px solid #16a34a;
      color:#bbf7d0;
    }
    .alert-error{
      background:#450a0a;
      border:1px solid #b91c1c;
      color:#fecaca;
    }
    .small{font-size:0.8rem;}
    .cliente-info-box{
      border-radius:10px;
      border:1px dashed #334155;
      padding:8px 10px;
      font-size:0.78rem;
      color:#9ca3af;
      min-height:52px;
    }
  </style>
  <!-- jsPDF para generar el PDF de la gu√≠a -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>BELOURA NY ‚Ä¢ Panel interno</h1>
      <div class="muted">
        Gesti√≥n de clientes y env√≠os de bodega NY a Ecuador.<br/>
        <span class="badge">Solo uso interno ‚Ä¢ No compartir enlace</span>
      </div>
    </header>

    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-cliente">‚ûï Registrar cliente</button>
      <button class="tab-btn" data-tab="tab-envio">üì¶ Registrar env√≠o</button>
    </div>

    <!-- TAB CLIENTE -->
    <section id="tab-cliente" class="card">
      <form id="formCliente">
        <div class="section-title">Datos del cliente (Ecuador)</div>
        <div class="grid grid-2">
          <div>
            <label for="cliNombre">Nombre completo</label>
            <input id="cliNombre" name="NombreCompleto" required />
          </div>
          <div>
            <label for="cliCedula">C√©dula</label>
            <input id="cliCedula" name="Cedula" required />
          </div>
        </div>

        <div class="grid grid-3" style="margin-top:10px;">
          <div>
            <label for="cliTelefono">Tel√©fono</label>
            <input id="cliTelefono" name="Telefono" required />
          </div>
          <div>
            <label for="cliWhatsApp">WhatsApp (opcional)</label>
            <input id="cliWhatsApp" name="WhatsApp" />
          </div>
          <div>
            <label for="cliEmail">Email (opcional)</label>
            <input id="cliEmail" name="Email" />
          </div>
        </div>

        <div class="grid grid-2" style="margin-top:10px;">
          <div>
            <label for="cliCiudad">Ciudad destino</label>
            <input id="cliCiudad" name="CiudadDestino" required placeholder="Babahoyo, Guayaquil, etc." />
          </div>
          <div>
            <label for="cliDireccion">Direcci√≥n</label>
            <input id="cliDireccion" name="Direccion" required />
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="cliNotas">Notas (opcional)</label>
          <textarea id="cliNotas" name="Notas" placeholder="Cliente recomendado, frecuencia, etc."></textarea>
        </div>

        <div class="section-title">Acciones</div>
        <div class="flex">
          <button type="submit" class="btn-primary" id="btnGuardarCliente">Guardar cliente</button>
          <button type="button" class="btn-secondary" id="btnLimpiarCliente">Limpiar</button>
        </div>

        <div id="alertCliente" class="alert" style="display:none;"></div>
      </form>
    </section>

    <!-- TAB ENV√çO -->
    <section id="tab-envio" class="card" style="display:none;">
      <form id="formEnvio">
        <div class="section-title">Datos del cliente</div>
        <div class="grid grid-2">
          <div>
            <label for="SelectCliente">Cliente</label>
            <select id="SelectCliente" required>
              <option value="">Seleccionar cliente‚Ä¶</option>
            </select>
            <span class="small muted">La lista se llena con los clientes registrados.</span>
          </div>
          <div>
            <label>Informaci√≥n del cliente</label>
            <div id="ClienteInfo" class="cliente-info-box">
              Selecciona un cliente para ver sus datos (nombre, c√©dula, tel√©fono, ciudad, direcci√≥n).
            </div>
          </div>
        </div>

        <!-- input oculto para llevar el C√≥digoCliente al payload -->
        <input type="hidden" id="CodigoCliente" name="CodigoCliente" />

        <div class="section-title">Remitente / origen</div>
        <div class="grid grid-3">
          <div>
            <label for="RemitenteNombre">Nombre remitente</label>
            <input id="RemitenteNombre" name="RemitenteNombre" required />
          </div>
          <div>
            <label for="RemitenteTelefono">Tel√©fono remitente</label>
            <input id="RemitenteTelefono" name="RemitenteTelefono" required />
          </div>
          <div>
            <label for="TiendaOrigen">Tienda origen</label>
            <input id="TiendaOrigen" name="TiendaOrigen" placeholder="Amazon, Shein, etc." />
          </div>
        </div>

        <div class="section-title">Paquete</div>
        <div class="grid grid-3">
          <div>
            <label for="Descripcion">Descripci√≥n</label>
            <input id="Descripcion" name="Descripcion" required placeholder="Ropa, zapatos, perfumes..." />
          </div>
          <div>
            <label for="PesoLb">Peso (lb)</label>
            <input id="PesoLb" name="PesoLb" type="number" step="0.01" min="0" required />
          </div>
          <div>
            <label for="ValorDeclarado">Valor declarado (USD)</label>
            <input id="ValorDeclarado" name="ValorDeclarado" type="number" step="0.01" min="0" required />
          </div>
        </div>

       <div class="grid grid-2" style="margin-top:10px;">
  <div>
    <label for="Tipo">Tipo de env√≠o</label>
    <select id="Tipo" name="Tipo" required>
      <option value="">Seleccionar‚Ä¶</option>
      <option value="4x4">4x4</option>
      <option value="Ropa">Ropa</option>
      <option value="Zapatos">Zapatos</option>
      <option value="Electronico">Electr√≥nico</option>
      <option value="Mixto">Mixto</option>
      <option value="Otro">Otro</option>
    </select>
  </div>
  <div>
    <label for="EstadoInicial">Estado inicial</label>
    <select id="EstadoInicial" name="EstadoInicial" required>
      <option value="Recibido en bodega NY">Recibido en bodega NY</option>
      <option value="Recibido en Arlington TX">Recibido en Arlington TX</option>
    </select>
  </div>
</div>

<div class="grid grid-2" style="margin-top:10px;">
  <div>
    <label for="TrackingInterno">Tracking interno (opcional)</label>
    <input id="TrackingInterno" name="TrackingInterno" placeholder="Tracking Miami/Guayaquil, etc." />
  </div>
  <div>
    <label for="CodigoGuiaSelect">Consolidar en gu√≠a (opcional)</label>
    <select id="CodigoGuiaSelect" name="CodigoGuiaSelect">
      <option value="">Sin consolidar (gu√≠a individual)</option>
    </select>
    <span class="small muted">
      Si este env√≠o forma parte de un paquete consolidado, selecciona aqu√≠ el c√≥digo de gu√≠a existente.
    </span>
  </div>
</div>

        <div class="section-title">Destinatario en Ecuador</div>
        <div class="grid grid-2">
          <div>
            <label for="DestNombre">Nombre completo</label>
            <input id="DestNombre" name="DestNombre" required />
          </div>
          <div>
            <label for="DestCedula">C√©dula</label>
            <input id="DestCedula" name="DestCedula" required />
          </div>
        </div>

        <div class="grid grid-3">
          <div>
            <label for="DestTelefono">Tel√©fono</label>
            <input id="DestTelefono" name="DestTelefono" required />
          </div>
          <div>
            <label for="CiudadDestino">Ciudad destino</label>
            <input id="CiudadDestino" name="CiudadDestino" required placeholder="Guayaquil, Babahoyo, etc." />
          </div>
          <div>
            <label for="DestReferencia">Referencia (opcional)</label>
            <input id="DestReferencia" name="DestReferencia" placeholder="Barrio, esquina, local cercano..." />
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="DestDireccion">Direcci√≥n completa</label>
          <input id="DestDireccion" name="DestDireccion" required placeholder="Calle, n√∫mero, intersecci√≥n..." />
        </div>

        <div class="section-title">Notas internas</div>
        <div>
          <label for="Observacion">Observaci√≥n (opcional)</label>
          <textarea id="Observacion" name="Observacion" placeholder="Instrucciones especiales, pago pendiente, etc."></textarea>
        </div>

        <div class="section-title">Acciones</div>
        <div class="flex">
          <button type="submit" class="btn-primary" id="btnGuardarEnvio">Guardar env√≠o + PDF gu√≠a</button>
          <button type="button" class="btn-secondary" id="btnLimpiarEnvio">Limpiar</button>
        </div>

        <div id="alertEnvio" class="alert" style="display:none;"></div>
      </form>
    </section>
  </div>

  <script>
    const API_URL   = "https://script.google.com/macros/s/AKfycbxbHBxXSBGQ_fYkKaryQGoQF_JMnjGDk006KkL3NkRbyezU1oUXGK95DO017w6WC6dFuw/exec";    // ‚Üê misma URL que en index.html
    const SECRET_KEY = "Beloura2025@";  // ‚Üê mismo SECRET_KEY que en Apps Script

    // Cache de clientes para rellenar select y mostrar info
    const clientesCache = {};

    // Tabs
    const tabs = document.querySelectorAll('.tab-btn');
    const tabSections = {
      'tab-cliente': document.getElementById('tab-cliente'),
      'tab-envio': document.getElementById('tab-envio')
    };

    tabs.forEach(btn => {
      btn.addEventListener('click', () => {
        tabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        Object.keys(tabSections).forEach(id => {
          tabSections[id].style.display = (id === btn.dataset.tab) ? 'block' : 'none';
        });
      });
    });

    // Helpers alertas
    function showAlert(element, message, ok) {
      element.style.display = 'block';
      element.textContent = message;
      element.className = 'alert ' + (ok ? 'alert-ok' : 'alert-error');
    }
    function clearAlert(element) {
      element.style.display = 'none';
      element.textContent = '';
    }

    /*********** CARGAR CLIENTES EN SELECT ***********/
    const selectCliente = document.getElementById('SelectCliente');
    const hiddenCodigoCliente = document.getElementById('CodigoCliente');
    const clienteInfoDiv = document.getElementById('ClienteInfo');
async function loadGuias() {
  const selectGuia = document.getElementById('CodigoGuiaSelect');
  if (!selectGuia) return;

  // deja solo la opci√≥n por defecto
  selectGuia.innerHTML = '<option value="">Sin consolidar (gu√≠a individual)</option>';

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'listGuias',
        secretKey: SECRET_KEY
      })
    });

    const data = await res.json();
    if (!data.ok) {
      console.warn('No se pudieron cargar gu√≠as:', data.error);
      return;
    }

    const guias = data.guias || [];
    guias.forEach(cg => {
      const opt = document.createElement('option');
      opt.value = cg;
      opt.textContent = cg;
      selectGuia.appendChild(opt);
    });
  } catch (e) {
    console.error('Error cargando gu√≠as:', e);
  }
}

    
    async function loadClientes() {
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({
            action: 'listClientes',
            secretKey: SECRET_KEY
          })
        });
        const data = await res.json();
        if (!data.ok) {
          console.error('Error listClientes:', data.error);
          return;
        }
        const clientes = data.clientes || [];
        selectCliente.innerHTML = '<option value="">Seleccionar cliente‚Ä¶</option>';
        clientes.forEach(c => {
          if (!c.CodigoCliente) return;
          clientesCache[c.CodigoCliente] = c;
          const opt = document.createElement('option');
          opt.value = c.CodigoCliente;
          opt.textContent = c.CodigoCliente + ' ‚Äì ' + (c.NombreCompleto || '');
          selectCliente.appendChild(opt);
        });
      } catch (err) {
        console.error('Error al cargar clientes:', err);
      }
    }

    function renderClienteInfo(code) {
      if (!code || !clientesCache[code]) {
        clienteInfoDiv.textContent = 'Selecciona un cliente para ver sus datos (nombre, c√©dula, tel√©fono, ciudad, direcci√≥n).';
        return;
      }
      const c = clientesCache[code];
      clienteInfoDiv.innerHTML = `
        <strong>${c.NombreCompleto || ''}</strong><br/>
        C√©dula: ${c.Cedula || ''}<br/>
        Tel: ${c.Telefono || ''}<br/>
        Ciudad: ${c.CiudadDestino || ''}<br/>
        Direcci√≥n: ${c.Direccion || ''}
      `;
    }

    selectCliente.addEventListener('change', () => {
      const code = selectCliente.value;
      hiddenCodigoCliente.value = code;
      renderClienteInfo(code);
    });

    document.addEventListener('DOMContentLoaded', loadClientes);

    /*********** CLIENTE ***********/
    const formCliente = document.getElementById('formCliente');
    const btnGuardarCliente = document.getElementById('btnGuardarCliente');
    const btnLimpiarCliente = document.getElementById('btnLimpiarCliente');
    const alertCliente = document.getElementById('alertCliente');

    btnLimpiarCliente.addEventListener('click', () => {
      formCliente.reset();
      clearAlert(alertCliente);
    });

    formCliente.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearAlert(alertCliente);

      const formData = new FormData(formCliente);
      const payload = {
        action: 'createCliente',
        secretKey: SECRET_KEY,
        NombreCompleto: formData.get('NombreCompleto') || '',
        Cedula: formData.get('Cedula') || '',
        Telefono: formData.get('Telefono') || '',
        WhatsApp: formData.get('WhatsApp') || '',
        Email: formData.get('Email') || '',
        CiudadDestino: formData.get('CiudadDestino') || '',
        Direccion: formData.get('Direccion') || '',
        Notas: formData.get('Notas') || ''
      };

      btnGuardarCliente.disabled = true;
      btnGuardarCliente.textContent = 'Guardando...';

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        const data = await res.json();

        if (!data.ok) {
          showAlert(alertCliente, 'Error al guardar cliente: ' + (data.error || 'desconocido'), false);
        } else {
          const codigo = data.codigoCliente || '';
          showAlert(alertCliente, 'Cliente creado correctamente. C√≥digo: ' + codigo, true);
          formCliente.reset();
          // Recargar lista de clientes para que aparezca el nuevo
          loadClientes();
        }
      } catch (err) {
        console.error(err);
        showAlert(alertCliente, 'Error de red al guardar cliente.', false);
      } finally {
        btnGuardarCliente.disabled = false;
        btnGuardarCliente.textContent = 'Guardar cliente';
      }
    });

    /*********** ENV√çO ***********/
    const formEnvio = document.getElementById('formEnvio');
    const btnGuardarEnvio = document.getElementById('btnGuardarEnvio');
    const btnLimpiarEnvio = document.getElementById('btnLimpiarEnvio');
    const alertEnvio = document.getElementById('alertEnvio');

    btnLimpiarEnvio.addEventListener('click', () => {
      formEnvio.reset();
      hiddenCodigoCliente.value = '';
      selectCliente.value = '';
      renderClienteInfo('');
      clearAlert(alertEnvio);
    });

    formEnvio.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearAlert(alertEnvio);

      const formData = new FormData(formEnvio);
      const codigoCliente = (formData.get('CodigoCliente') || '').toUpperCase().trim();

      if (!codigoCliente) {
        showAlert(alertEnvio, 'Debes seleccionar un cliente.', false);
        return;
      }

      const payload = {
        action: 'createEnvio',
        secretKey: SECRET_KEY,
        CodigoCliente: codigoCliente,
        RemitenteNombre: formData.get('RemitenteNombre') || '',
        RemitenteTelefono: formData.get('RemitenteTelefono') || '',
        TiendaOrigen: formData.get('TiendaOrigen') || '',
        Descripcion: formData.get('Descripcion') || '',
        PesoLb: formData.get('PesoLb') || '',
        ValorDeclarado: formData.get('ValorDeclarado') || '',
        Tipo: formData.get('Tipo') || '',
        EstadoInicial: formData.get('EstadoInicial') || '',
        TrackingInterno: formData.get('TrackingInterno') || '',
        DestNombre: formData.get('DestNombre') || '',
        DestCedula: formData.get('DestCedula') || '',
        DestTelefono: formData.get('DestTelefono') || '',
        CiudadDestino: formData.get('CiudadDestino') || '',
        DestDireccion: formData.get('DestDireccion') || '',
        DestReferencia: formData.get('DestReferencia') || '',
        Observacion: formData.get('Observacion') || '',
        Usuario: 'Leonardo',
        CodigoGuia: formData.get('CodigoGuiaSelect') || ''   // üëà NUEVO
      };

      btnGuardarEnvio.disabled = true;
      btnGuardarEnvio.textContent = 'Guardando...';

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        const data = await res.json();

        if (!data.ok) {
          showAlert(alertEnvio, 'Error al guardar env√≠o: ' + (data.error || 'desconocido'), false);
        } else {
          const codigoEnvio = data.codigoEnvio || '';
          showAlert(alertEnvio, 'Env√≠o creado correctamente. C√≥digo: ' + codigoEnvio, true);
          // üëá Generar gu√≠a en PDF tipo etiqueta
           await generarGuiaPDF(codigoEnvio, payload);
          const selectedCode = codigoCliente;
          formEnvio.reset();
          selectCliente.value = selectedCode;
          hiddenCodigoCliente.value = selectedCode;
          renderClienteInfo(selectedCode);

          const cliente = clientesCache[selectedCode] || null;
          generateGuiaPdf({
            codigoEnvio,
            codigoCliente: selectedCode,
            cliente,
            envio: payload
          });
        }
      } catch (err) {
        console.error(err);
        showAlert(alertEnvio, 'Error de red al guardar el env√≠o.', false);
      } finally {
        btnGuardarEnvio.disabled = false;
        btnGuardarEnvio.textContent = 'Guardar env√≠o + PDF gu√≠a';
      }
    });

    /*********** PDF DE GU√çA ***********/
    function generateGuiaPdf({ codigoEnvio, codigoCliente, cliente, envio }) {
      if (!window.jspdf) {
        console.warn('jsPDF no disponible');
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text('BELOURA COURIER', 105, 15, { align: 'center' });
      doc.setFontSize(11);
      doc.text('Gu√≠a de env√≠o', 105, 22, { align: 'center' });

      let y = 32;
      doc.setFontSize(10);
      doc.text(`C√≥digo env√≠o: ${codigoEnvio}`, 14, y); y += 6;
      doc.text(`C√≥digo cliente: ${codigoCliente}`, 14, y); y += 8;

      if (cliente) {
        doc.text('Cliente:', 14, y); y += 5;
        doc.text(`${cliente.NombreCompleto || ''}`, 20, y); y += 5;
        doc.text(`C√©dula: ${cliente.Cedula || ''}`, 20, y); y += 5;
        doc.text(`Tel: ${cliente.Telefono || ''}`, 20, y); y += 5;
        doc.text(`Ciudad: ${cliente.CiudadDestino || ''}`, 20, y); y += 5;
        doc.text(`Direcci√≥n: ${cliente.Direccion || ''}`, 20, y); y += 8;
      }

      doc.text('Destinatario:', 14, y); y += 5;
      doc.text(`${envio.DestNombre}`, 20, y); y += 5;
      doc.text(`C√©dula: ${envio.DestCedula}`, 20, y); y += 5;
      doc.text(`Tel: ${envio.DestTelefono}`, 20, y); y += 5;
      doc.text(`Ciudad: ${envio.CiudadDestino}`, 20, y); y += 5;
      doc.text(`Direcci√≥n: ${envio.DestDireccion}`, 20, y); y += 5;
      if (envio.DestReferencia) {
        doc.text(`Ref: ${envio.DestReferencia}`, 20, y); y += 8;
      } else {
        y += 4;
      }

      doc.text('Contenido:', 14, y); y += 5;
      doc.text(`${envio.Descripcion}`, 20, y); y += 5;
      doc.text(`Peso: ${envio.PesoLb} lb`, 20, y); y += 5;
      doc.text(`Valor declarado: $${envio.ValorDeclarado}`, 20, y); y += 5;
      doc.text(`Tipo: ${envio.Tipo}`, 20, y); y += 8;

      doc.text('Escanea el c√≥digo para rastrear tu env√≠o:', 14, y); y += 5;

      const qrUrl = `https://chart.googleapis.com/chart?cht=qr&chs=180x180&chl=${encodeURIComponent(codigoEnvio)}`;
      const img = new Image();
      img.crossOrigin = 'Anonymous';
      img.onload = function() {
        doc.addImage(img, 'PNG', 140, 40, 50, 50);
        doc.save(`Guia_${codigoEnvio}.pdf`);
      };
      img.onerror = function() {
        doc.save(`Guia_${codigoEnvio}.pdf`);
      };
      img.src = qrUrl;
    }
    async function generarGuiaPDF(codigoEnvio, data) {
  try {
    const { jsPDF } = window.jspdf;

    // Determinar si el env√≠o va consolidado o es individual
    // Se prioriza data.CodigoGuia, luego data.CodigoGuiaSelect, y si nada, se usa el propio CodigoEnvio
    const codigoGuia = (
      (data.CodigoGuia && data.CodigoGuia.trim()) ||
      (data.CodigoGuiaSelect && data.CodigoGuiaSelect.trim()) ||
      ''
    ).toUpperCase() || codigoEnvio;

    const esConsolidado = !!(
      (data.CodigoGuia && data.CodigoGuia.trim()) ||
      (data.CodigoGuiaSelect && data.CodigoGuiaSelect.trim())
    );

    // Formato 4x6 pulgadas (etiqueta)
    const doc = new jsPDF({
      orientation: 'portrait',
      unit: 'pt',
      format: [288, 432] // ancho, alto
    });

    // Datos base
    const pesoLb        = data.PesoLb || '';
    const destNombre    = data.DestNombre || '';
    const destCedula    = data.DestCedula || '';
    const destTelefono  = data.DestTelefono || '';
    const ciudadDestino = data.CiudadDestino || '';
    const destDireccion = data.DestDireccion || '';
    const tipo          = data.Tipo || '';
    const estadoInicial = data.EstadoInicial || 'Recibido en bodega NY';

    // Origen seg√∫n estado inicial
    let origenLinea1 = 'BELOURA COURIER';
    let origenLinea2 = '';
    let origenLinea3 = '';

    if (estadoInicial === 'Recibido en Arlington TX') {
      origenLinea2 = '2504 PLAZA ST';
      origenLinea3 = 'ARLINGTON TX 76010';
    } else {
      origenLinea2 = 'BODEGA NY';
      origenLinea3 = 'NEW YORK, NY';
    }

    // Cabecera (origen + peso)
    doc.setFont('Helvetica', 'Bold');
    doc.setFontSize(9);
    doc.text(origenLinea1, 18, 20);
    doc.setFont('Helvetica', 'Normal');
    doc.text(origenLinea2, 18, 32);
    doc.text(origenLinea3, 18, 44);

    doc.setFont('Helvetica', 'Bold');
    doc.setFontSize(10);
    doc.text(`${pesoLb} LBS`, 220, 20, { align: 'right' });
    doc.setFontSize(8);
    doc.text('1 OF 1', 220, 32, { align: 'right' });

    // L√≠nea separadora
    doc.setLineWidth(0.8);
    doc.line(18, 54, 270, 54);

    // SHIP TO
    doc.setFontSize(9);
    doc.setFont('Helvetica', 'Bold');
    doc.text('SHIP TO:', 18, 70);

    doc.setFont('Helvetica', 'Bold');
    doc.setFontSize(11);
    doc.text(destNombre.toUpperCase(), 18, 86);

    doc.setFont('Helvetica', 'Normal');
    doc.setFontSize(9);
    doc.text(destDireccion.toUpperCase(), 18, 100);
    doc.text(ciudadDestino.toUpperCase(), 18, 112);
    doc.text(`TEL: ${destTelefono}`, 18, 124);
    doc.text(`ID: ${destCedula}`, 18, 136);

    // Cuadro grande con el c√≥digo de gu√≠a (o de env√≠o si es individual)
    doc.setLineWidth(1.2);
    doc.rect(18, 150, 252, 80); // x, y, width, height

    doc.setFont('Helvetica', 'Bold');
    doc.setFontSize(24);
    doc.text(codigoGuia.replace('-', ' '), 144, 188, { align: 'center' });

    doc.setFontSize(9);
    let etiquetaTipo = tipo.toUpperCase();
    if (esConsolidado) {
      etiquetaTipo += (etiquetaTipo ? ' ‚Ä¢ ' : '') + 'CONSOLIDADO';
    } else {
      etiquetaTipo += (etiquetaTipo ? ' ‚Ä¢ ' : '') + 'INDIVIDUAL';
    }
    doc.text(etiquetaTipo, 144, 204, { align: 'center' });

    // Mostrar c√≥digo interno de env√≠o peque√±o debajo
    doc.setFontSize(8);
    doc.setFont('Helvetica', 'Normal');
    doc.text(`ENV√çO INTERNO: ${codigoEnvio}`, 144, 216, { align: 'center' });

    // QR apuntando a la p√°gina de Ecuador para esta gu√≠a
    const guiaParam = codigoGuia;
    const trackingUrl = `https://ny.beloura.shop/ecuador.html?guia=${encodeURIComponent(guiaParam)}`;

    const qrContainer = document.getElementById('qrcode');
    qrContainer.innerHTML = '';
    const qr = new QRCode(qrContainer, {
      text: trackingUrl,
      width: 120,
      height: 120,
      correctLevel: QRCode.CorrectLevel.M
    });

    // Esperar un momento para que el canvas se genere
    await new Promise(resolve => setTimeout(resolve, 300));

    const canvas = qrContainer.querySelector('canvas');
    if (canvas) {
      const dataUrl = canvas.toDataURL('image/png');
      // Posicionar QR debajo del cuadro del c√≥digo
      doc.addImage(dataUrl, 'PNG', 24, 242, 96, 96);
    }

    // ‚ÄúC√≥digo de barras‚Äù simple (placeholder visual)
    doc.setLineWidth(0.6);
    const baseY = 260;
    const barXStart = 140;
    const barXEnd = 260;
    for (let i = 0; i < 20; i++) {
      const x = barXStart + i * 3;
      const h = (i % 2 === 0) ? 70 : 55;
      doc.line(x, baseY, x, baseY + h);
    }

    doc.setFont('Helvetica', 'Normal');
    doc.setFontSize(8);
    doc.text(`TRACKING: ${codigoGuia}`, 200, 340, { align: 'center' });

    // Pie con marca
    doc.setLineWidth(0.6);
    doc.line(18, 360, 270, 360);
    doc.setFontSize(8);
    doc.setFont('Helvetica', 'Bold');
    doc.text('BELOURA COURIER', 18, 374);
    doc.setFont('Helvetica', 'Normal');
    doc.text('Gu√≠a interna para manejo log√≠stico y entrega en Ecuador.', 18, 386);
    doc.text('www.beloura.shop', 18, 398);

    // Descargar
    doc.save(`Guia_${codigoGuia}.pdf`);
  } catch (e) {
    console.error('Error generando PDF:', e);
    // No romper flujo si falla el PDF
  }
}

// Cargar gu√≠as disponibles al abrir el panel
loadGuias();

  </script>
  <div id="qrcode" style="display:none;"></div>
</body>
</html>
